<?php

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\node\Entity\Node;

/**
 * @file
 * Contains az_groups.module.
 */

function az_groups_form_node_form_alter(&$form, FormStateInterface $form_state, $form_id) {

  /**
   * Attempting to add groups and roles to the node form - on hold for now
  // Query for all groups.
  $query = \Drupal::database()->select('groups_field_data', 'gfd');
  $query->addField('gfd', 'id');
  $query->addField('gfd', 'label');
  $query->orderBy('gfd.label', 'ASC');
  $results = $query->execute()->fetchAllAssoc('id');

  // Set up groups array
  $groups = ['0' => 'None'];
  foreach($results as $result) {
    $groups[$result->id] = $result->label;
  }

  // Query for roles current user has in this? group.  WTF.  This ain't no fun.

  $form['group'] = [
    '#type' => 'fieldset',
    '#title' => t('Community'),
    'group_id' => [
      '#type' => 'select',
      '#title' => 'Community',
      '#default_value' => '0',
      '#options' => $groups,
    ],
    'group_role' => [
      '#type' => 'select',
      '#title' => 'Community Role',
      '#description' => 'Select the role that can view this post',
      '#options' => $options,
    ],
  ];

  $form['actions']['submit']['#submit'][] = '_az_groups_node_form_submit';
  **/
  return;
}

function _az_groups_node_form_submit($form, FormStateInterface $form_state) {
  $group = $form_state->getValue('group');
  return;
}

function az_groups_preprocess_group(&$variables) {

  $group = &$variables['group'];
  $az_wysiwyg = &drupal_static('az_wysiwyg', null);  // Save statically - used by WysiwygFilter
  $az_wysiwyg = [
    'group' => $group->id(),
    'view_mode' => $variables['view_mode'],
  ];

  $block_entity = Drupal\block\Entity\Block::load('groupoperations');
  $variables['block_groupoperations'] = \Drupal::entityTypeManager()->getViewBuilder('block')->view($block_entity);

  $block_entity = Drupal\block\Entity\Block::load('azbooknavigation');
  $variables['block_booknavigation'] = \Drupal::entityTypeManager()->getViewBuilder('block')->view($block_entity);

  $variables['view_group_members'] = views_embed_view('group_members', 'group_members');

  // Create Articles tab
  $articles = [
    'type' => 'entity-stream',
    'id' => 'articles',
    'label' => 'Articles',
    'types' => ['article'],
    'groups' => $group->id(),
    'title' => 'Articles',
    'status' => \Drupal\node\NodeInterface::PUBLISHED,
    'empty' => 'NO DISPLAY',
  ];

  // Create Featured Pages tab
  $featured = [
    'type' => 'entity-stream',
    'id' => 'featured-pages',
    'label' => 'Featured Pages',
    'types' => ['book'],
    'sticky' => true,
    'groups' => $group->id(),
    'title' => 'Featured Pages',
    'status' => NODE_PUBLISHED,
    'empty' => 'NO DISPLAY',
  ];

  // Create Recent Comments tab
  $comments = [
    'type' => 'entity-stream',
    'id' => 'recent-comments',
    'label' => 'Comments',
    'title' => 'Recent Comments',
    'entityType' => 'comment',
    'types' => ['article', 'event', 'book', 'news'],
    'groups' => $group->id(),
    'empty' => 'No comments posted for this community',
  ];

  // Create Events tab
  $events = [
    'type' => 'entity-stream',
    'id' => 'events',
    'label' => 'Events',
    'types' => 'event',
    'groups' => $group->id(),
    'title' => 'Upcoming Events',
    'status' => \Drupal\node\NodeInterface::PUBLISHED,
    'empty' => 'NO DISPLAY',
  ];

  // Create Resources tab
  $resources = [
    'type' => 'entity-stream',
    'id' => 'resource',
    'label' => 'Resources',
    'types' => ['link', 'document', 'video'],
    'entityType' => 'media',
    'groups' => $group->id(),
    'title' => 'Resources',
    'status' => \Drupal\node\NodeInterface::PUBLISHED,
//  'empty' => 'NO DISPLAY',
  ];

  // Create Images tab
  $images = [
    'type' => 'entity-stream',
    'id' => 'image',
    'label' => 'Images',
    'types' => ['image'],
    'entityType' => 'media',
    'groups' => $group->id(),
    'title' => 'Images',
    'pageNumItems' => 40,
    'status' => \Drupal\node\NodeInterface::PUBLISHED,
    'empty' => 'NO DISPLAY',
  ];

  $variables['tabs'] = _az_content_build_tabs('main', [
    $articles['id'] => $articles,
    $featured['id'] => $featured,
    $comments['id'] => $comments,
    $events['id'] => $events,
    $resources['id'] => $resources,
    $images['id'] => $images,
  ]);

  return;
}


